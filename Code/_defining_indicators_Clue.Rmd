---
title: "Defining sexual behavior, fertility and health indicators - Clue dataset"
author: "Laura Symul"
date: "4/18/2019"
output: html_document
---

```{r indicators_clue setup, include = FALSE, eval = TRUE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
source("Scripts/00_setup.R")
```


### Clue dataset

```{r indicators_clue load users table}
users = read_feather(path = paste0(IO$output_clue, "users.feather"))
```


#### Population indicators

```{r indicators_clue time_vec}
time_vec = seq(min(users$first_obs), max(users$last_obs), by = 1)
```



```{r indicators_clue building the population indicators table}

input_folder = paste0(IO$output_clue,"tracking/")
files = list.files(input_folder)

input_active_tracking = paste0(IO$tmp_clue,"active_tracking/")

indicators_folder = paste0(IO$output_clue, "pop_indicators/")
if(!dir.exists(indicators_folder)){dir.create(indicators_folder)}

if(!file.exists(paste0(indicators_folder, "sex_pop_indicators.feather"))){
  
  tic()
  tracking_pop_agg = foreach(file = files, .combine = rbind, .packages = c("dplyr","tidyverse")) %do% {
    cat("\t",file,"\t||")
    # tracking
    tracking = read_feather(path = paste0(input_folder, file))
    tracking$BC = dict$BC$type[match(tracking$birth_control_ud, dict$BC$birth_control)]
    tracking =  filter(tracking, BC %in% c("F","I"))
    
    # variables aggregates
    tracking_pop_agg = ddply(tracking,
                             .(date,country_area,BC),
                             summarise,
                             n_prot_sex = sum((category == "sex") & (type == "protected_sex"), na.rm = TRUE),
                             n_unprot_sex = sum((category == "sex") & (type == "unprotected_sex"), na.rm = TRUE),
                             n_wd_sex = sum((category == "sex") & (type == "withdrawal_sex"), na.rm = TRUE),
                             n_exercise = sum(category == "exercise", na.rm = TRUE),
                             n_long_sleep = sum((category == "sleep")&(type == ">9"), na.rm = TRUE),
                             n_bleeding = sum((category == "period")&(type != "spotting"), na.rm = TRUE),
                             n_medium_bleeding = sum((category == "period") & (type == "medium"), na.rm = TRUE),
                             n_breast_pain = sum((category == "pain") & (type == "tender_breasts"), na.rm = TRUE),
                             n_pill_taken = sum((category == "pill_hbc") & (type == "taken"), na.rm = TRUE)
    )
    
    tracking_pop_agg = tracking_pop_agg %>%  mutate(n_sex = n_prot_sex + n_unprot_sex + n_wd_sex)
    
    # active tracking
    active_tracking_compressed = read_feather(path = paste0(input_active_tracking,"active_",file))
    active_tracking = expand_compressed_tracking(active_tracking_compressed)
    active_tracking$BC = dict$BC$type[match(active_tracking$birth_control_ud, dict$BC$birth_control)]
    active_tracking =  filter(active_tracking, BC %in% c("F","I"))
    
    # total number of users
    active_tracking$country_area = tracking$country_area[match(active_tracking$user_id, tracking$user_id)]
    active_tracking_agg = ddply(active_tracking,
                                .(date,country_area,BC),
                                summarise,
                                n_users = sum(tracking, na.rm = TRUE)
    )
    
    
    
    tmp = dplyr::full_join(x = active_tracking_agg , y = tracking_pop_agg, by = c("date","country_area","BC")) %>%  
      arrange(country_area, BC, date) %>% 
      replace_na(list(n_prot_sex = 0,n_unprot_sex = 0, n_wd_sex= 0, n_sex = 0, 
                      n_party = 0, n_bleeding = 0, n_medium_bleeding = 0, n_breast_pain = 0, n_pill_taken = 0))
    
    return(tmp)
  }
  toc()
  
  tic()
  # sum the results from all files
  tmp = tracking_pop_agg %>% group_by(date, country_area, BC) %>% 
    summarise_each(.,sum) %>%  arrange(country_area, BC, date)
  # expand to have one row per possible date
  tmp2 = expand.grid(date = time_vec, country_area = unique(tmp$country_area), BC = unique(tmp$BC))
  tmp3 = dplyr::full_join(tmp, tmp2, by = c("date","country_area","BC")) %>%  
    arrange(country_area, BC, date) %>%  
    replace_na(., list(n_users = 0,n_prot_sex = 0,n_unprot_sex = 0, n_wd_sex= 0, n_sex = 0, 
                       n_party = 0, n_bleeding = 0, n_medium_bleeding = 0, n_breast_pain = 0, n_pill_taken = 0))
  # final table
  tracking_pop_agg = tmp3
  
  # save the results
  write_feather(tracking_pop_agg, path = paste0(indicators_folder, "sex_pop_indicators.feather"))
  toc()
  
}

```



```{r indicators_clue visualization of the pop indicators}

tracking_pop_agg = read_feather(path = paste0(indicators_folder, "sex_pop_indicators.feather"))

ggplot(tracking_pop_agg, aes(x = date, y = n_users, col = BC))+
  geom_line()+
  ggtitle("Total # of users per country and birth control")+
  facet_wrap(country_area ~ .)


ggplot(tracking_pop_agg, aes(x = date, y = n_sex/n_users, col = BC))+
  geom_line()+
  ggtitle("Relative sex freq. per country and birth control")+
  facet_wrap(country_area ~ .)


ggplot(tracking_pop_agg %>%  filter(date > as.Date("2017-06-30")), aes(x = date, y = n_sex/n_users, col = BC))+
  geom_line()+
  ggtitle("Relative sex freq. per country and birth control")+
  facet_grid(country_area ~ BC)


ggplot(tracking_pop_agg %>%  filter(date > as.Date("2017-06-30")), aes(x = date, y = n_prot_sex/n_users, col = BC))+
  geom_line()+
  ggtitle("Relative PROTECTED sex freq. per country and birth control")+
  facet_grid(country_area ~ BC)


ggplot(tracking_pop_agg %>%  filter(date > as.Date("2017-06-30")), aes(x = date, y = n_unprot_sex/n_users, col = BC))+
  geom_line()+
  ggtitle("Relative UNPROTECTED sex freq. per country and birth control")+
  facet_grid(country_area ~ BC)

```

```{r indicators_clue visualization of the pop indicators for other features than sex}

ggplot(tracking_pop_agg %>%  filter(date > as.Date("2017-06-30")), aes(x = date, y = n_exercise/n_users, col = BC))+
  geom_line()+
  ggtitle("Relative reported PHYSICAL EXERCISE freq. per country and birth control")+
  facet_grid(country_area ~ BC)


ggplot(tracking_pop_agg %>%  filter(date > as.Date("2017-06-30")), aes(x = date, y = n_long_sleep/n_users, col = BC))+
  geom_line()+
  ggtitle("Relative reported SLEEP duration >9h freq. per country and birth control")+
  facet_grid(country_area ~ BC)


ggplot(tracking_pop_agg %>%  filter(date > as.Date("2017-06-30")), aes(x = date, y = n_medium_bleeding/n_users, col = BC))+
  geom_line()+
  ggtitle("Relative reported MEDIUM BLEEDING freq. per country and birth control")+
  facet_grid(country_area ~ BC)



ggplot(tracking_pop_agg %>%  filter(date > as.Date("2017-06-30")), aes(x = date, y = n_breast_pain/n_users, col = BC))+
  geom_line()+
  ggtitle("Relative reported BREAST PAIN freq. per country and birth control")+
  facet_grid(country_area ~ BC)


```



