---
title: "Data preparation - Clue dataset"
author: "Laura Symul"
date: "4/18/2019"
output: html_document
---

```{r data_prep_clue setup, include = FALSE, eval = TRUE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
source("Scripts/00_setup.R")
```



### Clue dataset


#### Data overview

User table:

```{r data_prep_clue data overview users}
load(paste0(IO$input_clue,"users_filtered.Rdata"), verbose = TRUE)
head(users)
```


```{r data_prep_clue data overview cycles}
load(paste0(IO$input_clue,"cycles_filtered.Rdata"), verbose = TRUE)
dim(cycles)
head(cycles)
```


```{r data_prep_clue data overview tracking}

tracking_folder = paste0(IO$input_clue,"tracking_filtered/")
files = list.files(tracking_folder)

load(paste0(tracking_folder,files[1]), verbose = TRUE)
head(tracking)

unique(tracking$category)

```


#### Data preparation

* Re-assemble the tracking tables into batches, making sure a single user has all its tracking in the same batch

* [later] Filter the datasets to only keep the necessary features: we can remove `collection_method`, `appointment` (that's very little to remove - let's keep them)

* Add the users features to the tracking table

* [later] Re-classify cycles with regards to BC (easy way is to just keep *none* vs *pill* ; we might want to improve by adding other BC which might require a more complex method)

[now] Reuse the re-classification from the breast-tenderness project

* filter users to only take those with

- no BC transitions

- FAM or none / condoms

- at least a year of tracking

- enough FAM/ovulation-related features (`BBT`, `fluid` and `LH_test`)

##### Formating


```{r data_prep_clue reuse the BC-reclassification from the breast-tenderness project}

users_seas = users

load(paste0(IO$input_data,"TB output/users.Rdata"), verbose = TRUE)
users_TB = users

users = users_seas
rm(users_seas)

users$BC = users_TB$BC[match(users$user_id, users_TB$user_id)]
k = is.na(users$BC) & !(users$birth_control %in% c("did not enter","pill","none","condoms"))
users$BC[k] = users$birth_control[k]
users$BC[is.na(users$BC)] = "unclear"

table(users$BC, users$birth_control)

sum(users$BC %in% c("FAM","none / condoms"))

```

```{r data_prep_clue filter users and cycles to only keep FAM and none/condoms users }

users = users[users$BC %in% c("FAM","none / condoms"),]
save(users, file = paste0(IO$output_clue,"users.Rdata"))
file.copy(from = paste0(IO$output_clue,"users.Rdata"), to = paste0(IO$tmp_clue,"users_filtered_for_BC.Rdata"))


cycles = cycles[which(cycles$user_id %in% users$user_id), ]
save(cycles, file = paste0(IO$output_clue,"cycles.Rdata"))
file.copy(from = paste0(IO$output_clue,"cycles.Rdata"), to = paste0(IO$tmp_clue,"cycles_filtered_for_BC.Rdata"))

```







```{r data_prep_clue creating batches, adding users info and filter users}

max_batch_size = 5000
n_batch = max(par$min_n_batches, ceiling(nrow(users)/max_batch_size))
batch_size = ceiling(nrow(users)/n_batch)

users$batch = rep(1:n_batch, each = batch_size)[1:nrow(users)]

tracking_folder = paste0(IO$input_clue,"tracking_filtered/")
files = list.files(tracking_folder)

tracking_folder_batches_tmp = paste0(IO$tmp_data,"Clue/tracking_split_in_batches/")
if(!file.exists(tracking_folder_batches_tmp)){
  dir.create(tracking_folder_batches_tmp,recursive = TRUE)
}else{
  #clean directory
  file.remove(paste0(tracking_folder_batches_tmp,list.files(tracking_folder_batches_tmp)))
}


cl = makeCluster(par$n_cores)
registerDoParallel(cl)

tic()
users_original_file_ids = foreach(file = files, .combine = rbind) %dopar%
{
  cat(file, "\n")
  
  load(paste0(tracking_folder, file), verbose= TRUE)
  dim(tracking)
  #filter users
  tracking = tracking[tracking$user_id %in% users$user_id, ]
  dim(tracking)
  
  if(nrow(tracking)>0){
    # add user info
    tracking = merge(tracking, users, by = "user_id", all.x = TRUE)
    dim(tracking)
    tracking_all = tracking
    
    # save by batches
    for(b in unique(tracking$batch)){
      new_file_name = gsub("_filtered_split",paste0("_batch_",b),file)
      tracking = tracking_all[which(tracking$batch == b),]
      save(tracking, file = paste0(tracking_folder_batches_tmp, new_file_name ))
    }
    
    users_original_file_ids = data.frame(user_id = unique(tracking_all$user_id), original_file_id = substr(file,25,26))
  }else{  users_original_file_ids = data.frame(user_id = character(), original_file_id = character())}
  
  return(users_original_file_ids)
}
toc()
stopImplicitCluster()


users_o_f = aggregate(original_file_id ~ user_id ,users_original_file_ids, paste0, collapse = ",")
users$original_files = users_o_f$original_file_id[match(users$user_id, users_o_f$user_id)]

save(users, file = paste0(IO$output_clue,"users.Rdata"))

```




```{r data_prep_clue re-assembling the batches together}

tracking_folder_output = paste0(IO$output_data,"Clue/tracking/")
if(file.exists(tracking_folder_output)){unlink(tracking_folder_output, recursive = TRUE)}
dir.create(tracking_folder_output,recursive = TRUE)

tracking_folder_output_tmp = paste0(IO$tmp_data,"Clue/tracking_adding_users_info_and_new_batches/")
if(file.exists(tracking_folder_output_tmp)){unlink(tracking_folder_output_tmp, recursive = TRUE)}
dir.create(tracking_folder_output_tmp,recursive = TRUE)


cl = makeCluster(par$n_cores)


batches = unique(users$batch)
foreach(b = batches) %do%
{
  cat(b,"\n")
  all_files = list.files(tracking_folder_batches_tmp)
  files = all_files[grep(paste0("_batch_",b,"_"),all_files)]
  
  registerDoParallel(cl)
  tracking = foreach(file  = files, .combine = rbind) %dopar%
  {
    cat(file, "\n")
    load(paste0(tracking_folder_batches_tmp, file), verbose= TRUE)
    return(tracking)
  }
  stopImplicitCluster()
  
  new_file_name = paste0("tracking_",b,".Rdata")
  save(tracking, file = paste0(tracking_folder_output, new_file_name ))
  file.copy(from = paste0(tracking_folder_output, new_file_name ), to = paste0(tracking_folder_output_tmp, new_file_name))
}


```


```{r data_prep_clue format dates}

cycles$cycle_start = as.Date(cycles$cycle_start)

tracking_folder = paste0(IO$output_data,"Clue/tracking/")
files = list.files(tracking_folder)

cl = makeCluster(par$n_cores)
registerDoParallel(cl)
foreach(file = files) %dopar%
{
  load(paste0(tracking_folder, file), verbose= TRUE)
  tracking$date = as.Date(tracking$date)
  save(tracking, file = paste0(tracking_folder, file ))
}
stopImplicitCluster()



```


```{r data_prep_clue format weight height}

sort(unique(users$age))
sort(unique(users$weight))
sort(unique(users$height))

users$weight[users$weight == -999] = NA
users$height[users$height == -999] = NA


```



##### filter to only keep "best" users

* At least 2 years of tracking

* users with enough `BBT`, `fluid` and `LH_test`

```{r data_prep_clue users aggregate for selecting best users}

tracking_folder = paste0(IO$output_clue,"tracking/")
filenames = list.files(tracking_folder)

cl = makeCluster(par$n_cores)
registerDoParallel(cl)

users_aggregate = foreach(filename = filenames, .combine = rbind, .packages = c('plyr','dplyr')) %dopar% 
{
  cat(filename,"\n")
  load(paste0(tracking_folder, filename), verbose = TRUE)
  
  users_agg = ddply(tracking, .(user_id), 
                    .parallel=TRUE ,  
                    .fun = summarize,
                    n_days_obs = lu(date),
                    first_obs_date = min(date),
                    last_obs_date = max(date),
                    n_obs = length(date),
                    n_pill = sum(category == "pill_hbc"),
                    n_other_BC = sum(category %in% c("patch_hbc","ring_hbc","injection_hbc","iud")) ,
                    n_tot_sex = sum(type %in% c("withdrawal_sex","protected_sex","unprotected_sex")),
                    n_prot_sex = sum(type == "protected_sex"),
                    n_unprot_sex =  sum(type == "unprotected_sex"),
                    n_withdrawal =  sum(type == "withdrawal_sex"),
                    n_egg_white_fluid = sum(type %in% c("egg_white")),
                    n_fam_fluid = sum(type %in% c("egg_white","creamy","sticky")),
                    n_ovu_test = sum(type %in% c("ovulation_test_pos","ovulation_test_neg")),
                    #n_preg_test = sum(type %in% c("preg_test_pos","preg_test_neg")),
                    n_BBT = sum((category == "bbt") & (!is.na(number)))
  )
  return(users_agg)
}

stopCluster(cl)

save(users_aggregate, file = paste0(IO$tmp_clue, "users_aggregate_data_prep.Rdata"))



```



```{r data_prep_clue selecting best users}

users_aggregate$tracking_duration = as.numeric(users_aggregate$last_obs_date -  users_aggregate$first_obs_date)

filter = (users_aggregate$tracking_duration >= (2*365)) & # 2 years of tracking
  (users_aggregate$n_days_obs >= 365) &  # average tracking frequency of over 1/2
  ((users_aggregate$n_BBT >= 100) | 
     (users_aggregate$n_ovu_test >= 10) | 
     (users_aggregate$n_fam_fluid >= 150) | 
     (users_aggregate$n_egg_white_fluid >= 50)) & # enough FAM/ovulation related signs
  (users_aggregate$n_pill == 0) &
  (users_aggregate$n_other_BC == 0)
sum(filter)

best_users = users_aggregate$user_id[which(filter)]

users = users[users$user_id %in% best_users,]
save(users, file = paste0(IO$output_clue, "users.Rdata"))
save(users, file = paste0(IO$tmp_clue, "users_best_users.Rdata"))

cycles = cycles[cycles$user_id %in% best_users,]
save(cycles, file = paste0(IO$output_clue, "cycles.Rdata"))
save(cycles, file = paste0(IO$tmp_clue, "cycles_best_users.Rdata"))


tracking_folder = paste0(IO$output_clue,"tracking/")
filenames = list.files(tracking_folder)

cl = makeCluster(par$n_cores)
registerDoParallel(cl)

tracking = foreach(filename = filenames, .combine = rbind) %dopar% 
{
  cat(filename,"\n")
  load(paste0(tracking_folder, filename), verbose = TRUE)
  tracking = tracking[tracking$user_id %in% best_users,]
  return(tracking)
}

stopCluster(cl)

save(tracking, file = paste0(IO$output_clue, "tracking.Rdata"))
save(tracking, file = paste0(IO$tmp_clue, "tracking_best_users.Rdata"))


```








##### Defining cycle ids

```{r data_prep_clue cycle_ids}

cycles$cycle_nb = cycles$cycle_id
cycles$cycle_id = paste0(cycles$user_id,"_",cycles$cycle_id)

save(cycles, file = paste0(IO$output_clue, "cycles.Rdata"))
file.copy(from = paste0(IO$output_clue, "cycles.Rdata"), to = paste0(IO$tmp_clue, "cycles_with_cycle_ids.Rdata"))

# ADDING CYCLE IDs to TRACKING

# expand cycles for each day
cycles_exp = as.data.frame(lapply(cycles, rep, cycles$cycle_length))
cycles_exp$cycleday = ave(rep(1,nrow(cycles_exp)), cycles_exp$cycle_id, FUN =cumsum)
cycles_exp$date = cycles_exp$cycle_start + (cycles_exp$cycleday - 1)
cycles_exp$day_id = paste0(cycles_exp$user_id, "_", cycles_exp$date)
  
tracking$day_id = paste0(tracking$user_id, "_",tracking$date)  
# match tracking and cycles_sub_exp
m = match(tracking$day_id, cycles_exp$day_id)
tracking$cycle_nb = cycles_exp$cycle_nb[m]
tracking$cycle_id = cycles_exp$cycle_id[m]
tracking$cycle_length = cycles_exp$cycle_length[m]
tracking$cycleday = cycles_exp$cycleday[m]
  
tracking$cycleday_from_end = tracking$cycleday - tracking$cycle_length - 1
  
d = duplicated(tracking[,c("user_id","date","category","type","cycleday")])
if(sum(d)>0){tracking = tracking[-which(d),]}

save(tracking, file = paste0(IO$output_clue, "tracking.Rdata"))
file.copy(from =  paste0(IO$output_clue, "tracking.Rdata"), to =  paste0(IO$tmp_clue, "tracking_with_cycle_ids.Rdata"))

```


