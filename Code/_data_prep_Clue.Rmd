---
title: "Data preparation - Clue dataset"
author: "Laura Symul"
date: "4/18/2019"
output: html_document
---

```{r data_prep_clue setup, include = FALSE, eval = TRUE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
source("Scripts/00_setup.R")
```



### Clue dataset


#### Data overview

User table:

```{r data_prep_clue data overview users}
users = read_feather(path = paste0(IO$input_clue,"users.feather"))
head(users)
dim(users)
```


```{r data_prep_clue data overview cycles}

cycles_00 = read_feather(path = paste0(IO$input_clue,"cycles/cycles0000.feather"))
head(cycles_00)
dim(cycles_00)
```


```{r data_prep_clue data overview tracking}

tracking_folder = paste0(IO$input_clue,"tracking/")
files = list.files(tracking_folder)

tracking = read_feather(path = paste0(tracking_folder,files[1]))
head(tracking)

unique(tracking$category)

```


#### Data preparation 

Workflow:

* Split Country and Area

* Compute estimated mean BMI

* Re-assemble the tracking tables into batches, making sure a single user has all its tracking in the same batch

* Add the users features to the tracking table

* Label user's time-series


+ Birth control (as declared by users)

+ Birth control (re-assignment based on users' declaration and on their tracking history - see Breast Tenderness paper method)


* User's tracking activity (convolution by X days from "ANY" tracking to reflect that the user was using the app)



##### Countries and Areas

```{r data_prep_clue countries}
countries_areas = users$country_area %>% str_split_fixed(., " - ", n = 2)
users$country = countries_areas[,1]
users$area = countries_areas[,2]

write_feather(users, path = paste0(IO$output_clue, "users.feather"))
ok = file.copy(from = paste0(IO$output_clue, "users.feather"), to = paste0(IO$tmp_clue, "users_with_countries.feather"))
```


##### BMI

```{r data_prep_clue BMI}

users$height_bin = factor(users$height_bin, levels = dict$height$bin)
users$weight_bin = factor(users$weight_bin, levels = dict$weight$bin)
heigh_mean = dict$height$mean[match(users$height_bin,dict$height$bin)]
weight_mean = dict$weight$mean[match(users$weight_bin,dict$weight$bin)]
users$est_mean_bmi = weight_mean/((heigh_mean/100)^2)

write_feather(users, path = paste0(IO$output_clue, "users.feather"))
ok = file.copy(from = paste0(IO$output_clue, "users.feather"), to = paste0(IO$tmp_clue, "users_with_bmi.feather"))


ggplot(users, aes(x = est_mean_bmi, fill = country_area))+
  geom_histogram(binwidth = 2)+
  facet_grid(country_area ~ ., scale = "free_y")
```



##### Batches and tracking tables augmentation

```{r data_prep_clue defining the batches}

max_batch_size = 5000
n_batch = max(par$min_n_batches, ceiling(nrow(users)/max_batch_size))
batch_size = ceiling(nrow(users)/n_batch)

users$batch = rep(1:n_batch, each = batch_size)[1:nrow(users)]
write_feather(users, path = paste0(IO$output_clue, "users.feather"))
ok = file.copy(from = paste0(IO$output_clue, "users.feather"), to = paste0(IO$tmp_clue, "users_with_batches.feather"))

```


```{r data_prep_clue filtering tracking tables by batches}

tracking_folder = paste0(IO$input_clue,"tracking/")
files = list.files(tracking_folder)

tmp_folder = paste0(IO$tmp_clue,"tracking_split_in_batches/")
if(!file.exists(tmp_folder)){
  dir.create(tmp_folder,recursive = TRUE)
  
  cl = makeCluster(par$n_cores)
  registerDoParallel(cl)
  
  tic()
  users_original_file_ids = foreach(file = files, .combine = rbind, .packages = c("feather","stringr")) %dopar%
  {
    tracking = read_feather(path = paste0(tracking_folder, file))
    dim(tracking)
    tracking$batch = users$batch[match(tracking$user_id, users$user_id)]
    if(nrow(tracking)>0){
      for(b in unique(tracking$batch)){
        tracking_batch = tracking[which(tracking$batch == b),]
        new_file_name = gsub(".feather",paste0("_batch_",b,".feather"),file)
        write_feather(tracking_batch, path = paste0(tmp_folder, new_file_name ))
      }
      users_original_file_ids = data.frame(user_id = unique(tracking$user_id), original_file_id = str_extract(file,"\\d{4}"))
    }else{  users_original_file_ids = data.frame(user_id = character(), original_file_id = character())}
    return(users_original_file_ids)
  }
  toc()
  stopImplicitCluster()
  
  users_o_f = aggregate(original_file_id ~ user_id ,users_original_file_ids, function(x)  paste0(sort(x), collapse = ","))
  colnames(users_o_f) = c("user_id","original_tracking_files")
  write_feather(users_o_f, path = paste0(IO$tmp_clue,"original_tracking_files_per_users.feather"))
}

```


```{r data_prep_clue re-assembling the batches together}

input_folder = paste0(IO$tmp_clue,"tracking_split_in_batches/")
output_folder = paste0(IO$output_clue,"tracking/")
if(file.exists(output_folder)){unlink(output_folder, recursive = TRUE)} ;dir.create(output_folder,recursive = TRUE)
tmp_folder = paste0(IO$tmp_clue,"tracking_in_batches/")
if(!dir.exists(tmp_folder)){
  dir.create(tmp_folder,recursive = TRUE)
  
  batches = unique(users$batch)
  ok = foreach(b = batches) %do% {
    cat("\t",b,"||\t")
    all_files = list.files(input_folder)
    files = all_files[grep(paste0("_batch_",b,"\\."),all_files)]
    
    cl = makeCluster(par$n_cores)
    registerDoParallel(cl)
    tracking = foreach(file  = files, .combine = rbind, .packages = "feather") %dopar%{tracking = read_feather(path = paste0(input_folder, file));return(tracking)}
    stopImplicitCluster()
    
    cols_to_add = c("birth_year_bin","country_area","height_bin","weight_bin", "est_mean_bmi")
    m = match(tracking$user_id, users$user_id)
    for(col_to_add in cols_to_add){
      eval(parse(text = paste0("tracking$",col_to_add," = users$",col_to_add,"[m]")))
    }
    o = order(tracking$user_id, tracking$date, tracking$category, tracking$type, tracking$number)
    tracking = tracking[o,]
    
    new_file_name = paste0("tracking_",b,".feather")
    write_feather(tracking, path = paste0(output_folder, new_file_name ))
    ok = file.copy(from = paste0(output_folder, new_file_name ), to = paste0(tmp_folder, new_file_name), overwrite = TRUE)
  }
}
```

##### Augmenting the users table


```{r data_prep_clue aggregating key tracking info at the users level}

if(!file.exists(paste0(IO$tmp_clue, "users_agg.feather"))){
  
  tracking_folder = paste0(IO$output_clue,"tracking/")
  files = list.files(tracking_folder)
  
  cl = makeCluster(par$n_cores)
  registerDoParallel(cl)
  
  tic()
  users_agg = foreach(file = files, .combine = rbind, .packages = c("feather","stringr", "plyr")) %dopar%
  {
    tracking = read_feather(path = paste0(tracking_folder, file))
    users_agg = ddply(tracking,
                      .(user_id),
                      summarize,
                      first_obs = min(date),
                      last_obs = max(date),
                      n_obs_day = length(unique(date)),
                      n_obs = sum(category != "ANY"),
                      n_sex = sum(category == "sex"),
                      n_mucus =  sum(category == "fluid"),
                      n_temp = sum(category == "bbt")
    )
    return(users_agg)
  }
  toc()
  stopImplicitCluster()
  
  write_feather(users_agg, path = paste0(IO$tmp_clue, "users_agg.feather"))
  
}

```

```{r data_prep_clue augmenting the users table}

users_agg = read_feather(path = paste0(IO$tmp_clue, "users_agg.feather"))

cols_to_add = setdiff(colnames(users_agg),"user_id")
m = match(users$user_id, users_agg$user_id)
for(col_to_add in cols_to_add){eval(parse(text = paste0("users$",col_to_add," = users_agg$",col_to_add,"[m]")))}
users$n_days = as.numeric(users$last_obs - users$first_obs)

write_feather(users, path = paste0(IO$output_clue, "users.feather"))
ok = file.copy(from = paste0(IO$output_clue, "users.feather"), to = paste0(IO$tmp_clue, "users_augmented.feather"))
```



##### Birth control


As declared by the users:

```{r data_prep_clue birth_control table}

BC = read_feather(path = paste0(IO$input_clue,"birth_control.feather"))
o = order(BC$user_id, BC$date)
BC = BC[o,]
BC$birth_control = replace_na(BC$birth_control, "undefined")

write_feather(BC, path = paste0(IO$output_clue, "birth_control.feather"))
```


```{r data_prep_clue adding birth_control table to tracking table}

BC = read_feather(path = paste0(IO$output_clue,"birth_control.feather"))

input_folder = paste0(IO$tmp_clue,"tracking_in_batches/")
output_folder = paste0(IO$output_clue,"tracking/")
tmp_folder = paste0(IO$tmp_clue, "tracking_with_user_defined_birth_control/")
if(!dir.exists(tmp_folder)){
  
  dir.create(tmp_folder)
  
  files = list.files(input_folder)
  
  cl = makeCluster(par$n_cores)
  registerDoParallel(cl)
  
  tic()
  catch = 
    foreach(file = files, 
            .combine = rbind, 
            .packages = c("feather","stringr", "plyr","tidyverse")
    ) %dopar% {
      tracking = read_feather(path = paste0(input_folder, file))
      agg = aggregate(date ~ user_id, tracking, min)
      min_date = agg$date[match(tracking$user_id, agg$user_id)]
      tracking = tracking %>%  mutate(rel_date = as.numeric(date - min_date + 1))
      
      u_tracking = tracking %>% 
        select(user_id, date) %>%  unique() %>%  
        mutate(birth_control = NA,pill_type = NA, pill_regiment = NA)
      u_BC = BC %>% select(-csv_file) %>% filter(user_id %in% unique(tracking$user_id)) %>%  unique() 
      BC_exp = rbind(u_tracking, u_BC) %>%  arrange(., user_id, date)
      
      # need to expand the birth_control variables to replace the NAs with the latest value in the file
      BC_exp = BC_exp %>% group_by(user_id) %>% mutate(
        birth_control = replace_NAs_with_latest_value(birth_control) %>%  replace_na("undefined"),
        pill_type = replace_NAs_with_latest_value(pill_type),
        pill_regiment = replace_NAs_with_latest_value(pill_regiment)
      )
      
      tracking_key = str_c(tracking$user_id, "_",tracking$date)
      BC_key = str_c(BC_exp$user_id,"_",BC_exp$date)
      m = match(tracking_key,BC_key)
      tracking$birth_control_ud = BC_exp$birth_control[m]
      tracking$pill_type_ud = BC_exp$pill_type[m]
      tracking$pill_regiment_ud = BC_exp$pill_regiment[m]
      
      
      write_feather(tracking, path = paste0(output_folder,file))
      file.copy(from = paste0(output_folder,file), to = paste0(tmp_folder,file), overwrite = TRUE)
    }
  toc()
  stopImplicitCluster()
}

```

##### Users' active tracking periods


```{r}

active_tracking_filter = function(x, N = 28*1.5){
  res = stats::filter(c(rep(0,N-1),x), filter = rep(1,N), sides = 1) %>% pmin(1)
  res = na.omit(res) %>%  as.vector()
  return(res)
}

```


```{r data_prep_clue users active tracking periods }

input_folder = paste0(IO$output_clue,"tracking/")
files = list.files(input_folder)

output_folder = paste0(IO$tmp_clue, "active_tracking/")
if(!dir.exists(output_folder)){
  
  dir.create(output_folder)
  
  
  time_vec = seq(min(users$first_obs), max(users$last_obs), by = 1)
  
  cl = makeCluster(par$n_cores)
  registerDoParallel(cl)
  tic()
  ok = 
    foreach(file = files, 
            .packages = c("dplyr", "feather")) %dopar% {
              tracking = read_feather(path = paste0(input_folder, file))
              
              any_tracking = tracking %>% filter(. , category == "ANY")  %>% 
                select(c(user_id, date, birth_control_ud))
              any_tracking$tracking_days = 1
              tmp = data.frame(
                user_id = rep(unique(tracking$user_id), each = length(time_vec)), 
                date = rep(time_vec, lu(tracking$user_id)))
              active_tracking = dplyr::full_join(tmp,any_tracking, by = c("user_id","date"))
              active_tracking$tracking_days[is.na(active_tracking$tracking_days)] = 0
              active_tracking$birth_control_ud = ave(active_tracking$birth_control_ud, 
                                                     by =  active_tracking$user_id, 
                                                     FUN = replace_NAs_with_latest_value)
              active_tracking = active_tracking %>%  group_by(user_id) %>%  
                mutate(., tracking = active_tracking_filter(tracking_days))
              active_tracking = active_tracking %>% select(user_id, date,birth_control_ud, tracking)
              
              # compressed table
              active_tracking  = active_tracking %>%  group_by(user_id, birth_control_ud) %>% 
                mutate(transition = diff(c(0, tracking)))
              active_tracking  = active_tracking %>%  group_by(user_id) %>% 
                mutate(stretch_num = cumsum(transition == 1))
              active_tracking  = active_tracking %>%  
                group_by(user_id, birth_control_ud, stretch_num, tracking) %>%  
                mutate(stretch_length = sum(tracking))
              compressed_tracking = active_tracking %>% filter(transition == 1) %>%  
                select(user_id, date,birth_control_ud, stretch_num, stretch_length) %>%  
                rename(start_date = date)
              
              file_name = paste0("active_",file)
              write_feather(compressed_tracking, path = paste0(output_folder,file_name))
            }
  toc()
  stopImplicitCluster()
  
}

```


