---
title: "Birth seasonality"
author: "Laura Symul"
date: "7/20/2018"
output: html_document
---

# Introduction 

## Birth Seasonality

It has been well documented that live birth follows a seasonal pattern with more babies born in Spring/Summer in most countries of the northen Hemisphere.

We downloaded monthly live birth data from the UN [http://data.un.org/Data.aspx?d=POP&f=tableCode%3A55] 


```{r intro_birth_seasonality getting-birth-data}

birth = read.csv(paste0(IO$public_birth_records,"UNdata_Export_20180713_023958101_all.csv"), header = TRUE)

# removing the rows with the total number of birth - only keeping the monthly data
months = format(ISOdate(2004,1:12,1),"%B")
j = birth$Month %in% months
birth = birth[which(j),]
rm(j)

# proper date
birth$date = as.Date(paste0(birth$Year, "-",birth$Month,"-01"), format = c("%Y-%B-%d"))
range(birth$date)

# matching country names with countriesLow Names
birth$Country.or.Area = gsub("United States of America","United States", birth$Country.or.Area)

# getting geo-location
mat = match(birth$Country.or.Area, countriesLow$NAME)

birth$lat = countriesLow$LAT[mat]
birth$lon = countriesLow$LON[mat]
rm(mat)

# sorting countries by latitude

countries.levels = unique(birth$Country.or.Area)
m = match(countries.levels,countriesLow$NAME )
lat = countriesLow$LAT[m]
o = order(lat, decreasing = TRUE)
countries.levels = countries.levels[o]

birth$Country.or.Area = factor(birth$Country.or.Area, levels = countries.levels)

rm(countries.levels, m, lat, o)

```



```{r intro_birth_seasonality displaying-birth-data}

# "Australia", "New Zealand","Bermuda", "Greenland", "Guadeloupe",
countries = c("Sweden","Denmark","Finland","Canada","Germany", "France", "Switzerland", "United States","Israel","Japan","Guatemala","American Samoa","New Caledonia","Seychelles","Chile")
# order countries by decreasing latitude
mat = match(countries, countriesLow$NAME)
lat = countriesLow$LAT[mat]
o = order(lat, decreasing = TRUE)
countries = countries[o]
rm(o, lat, mat)

# select countries. Selected countries had long term data and included those from Northern and Southern hemisphere
c = which(birth$Country.or.Area %in% countries)


g = ggplot(birth[c,], aes(x = date, y = Value, col = Country.or.Area))
g + geom_line() + ggtitle("Absolute number of live birth for selected countries")

g = ggplot(birth[c,], aes(x = date, y = Value, col = Country.or.Area))
g + geom_line() + facet_grid( Country.or.Area ~ . , scales = "free_y") + 
  theme(strip.text.y = element_text(angle = 90))  + 
  ggtitle("Number of live birth for selected countries /!\ y-scale does not include 0")

```


```{r intro_birth_seasonality displaying-birth-data last 2 decades, fig.height=3.5, fig.width=8}

countries2 = countries[-which(countries %in% c("Guatemala","Switzerland","Finland"))]

cc = which((birth$Country.or.Area %in% countries2) & (birth$Year >= 2000))


g = ggplot(birth[cc,], aes(x = date, y = Value, col = Country.or.Area))
g + geom_line() + facet_grid( Country.or.Area ~ . , scales = "free_y") + 
  theme(strip.text.y = element_text(angle = 0,hjust = 0),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())+ #expand_limits(y=25)+
  guides(col = FALSE)+ ylab("Number of live births (min to max values)")+
  ggtitle("Number of live birth for selected countries in the last 2 decades")


```



```{r intro_birth_seasonality displaying-birth-data others}

long_ago = 1978:1981

cc = which((birth$Country.or.Area %in% c("Finland","France","United States", "Israel")) & (birth$Year %in% long_ago))


g = ggplot(birth[cc,], aes(x = date, y = Value, col = Country.or.Area))
g + geom_line() + facet_grid( Country.or.Area ~ . , scales = "free_y") + 
  theme(strip.text.y = element_text(angle = 90)) + 
  ggtitle("Number of live birth for selected countries in the late 70's")



cc = which((birth$Country.or.Area %in% countries) & (birth$Year %in% long_ago))

g = ggplot(birth[cc,], aes(x = date, y = Value, col = Country.or.Area))
g + geom_line() + facet_grid( Country.or.Area ~ . , scales = "free_y") + 
  theme(strip.text.y = element_text(angle = 90)) + 
  ggtitle("Number of live birth for selected countries in the late 70's")


recently = 2011:2013

cc = which((birth$Country.or.Area %in% c("Finland","France","United States", "Israel")) & (birth$Year %in% recently))


g = ggplot(birth[cc,], aes(x = date, y = Value, col = Country.or.Area))
g + geom_line() + facet_grid( Country.or.Area ~ . , scales = "free_y") + 
  theme(strip.text.y = element_text(angle = 90)) + 
  ggtitle("Number of live birth for selected countries in recent years")




sh = which(birth$lat < 0)

g = ggplot(birth[sh,], aes(x = date, y = Value, col = Country.or.Area))
g + geom_line() + facet_grid( Country.or.Area ~ . , scales = "free_y") + 
  theme(strip.text.y = element_text(angle = 90)) + 
  ggtitle("Number of live birth for selected countries in the SOUTH hemisphere")

rm(sh)


```


Martinez-Bakker et al., 2014 have shown that the peak time of birth follows a pattern that depends on the latitude of the considered country.

image: ![Martinez-Bakker](resources/Seasonality_fig3.png)


To better understand this relationship and to later investigate the potential origin of birth seasonality, we do a rhythm analysis of the birth patterns to determine the phase (= the peak time) and the relative amplitude of the birth signals, taken year by year.


```{r intro_birth_seasonality birth-rhythm-analysis}

BR = data.frame()

for(country in unique(birth$Country.or.Area)){
  
  c = which(birth$Country.or.Area == country)
  b = birth[c,]
  years = table(b$Year)
  years = names(years)[years == 12]
  
  for(y in years){
    
    j = which(b$Year == y)
    
    pft = periodic.fisher.test(t = 1:12, x = b$Value[j], p = 12)
    
    line = data.frame(country = country, year = as.numeric(y), pval = pft$pval , phase = pft$phase, rel.ampl = pft$rel.amp)
    
    BR = rbind(BR, line)
    
  }
}

rm(line,c, b, j,y, country, pft, years)
hist(BR$pval, breaks = 50)
# we expect p-value to be small if there is rhythmicity
BR$qval = p.adjust(BR$pval, method = "BH")


```


```{r intro_birth_seasonality birth-rhythm-plots, fig.height=3.5, fig.width=7}

# and plot the phase (in month), show the p-value and order by latitude. 

m = match(BR$country, countriesLow$NAME)
BR$lat = countriesLow$LAT[m]
BR$lon = countriesLow$LON[m]
BR$significant_rhythm = BR$qval<=0.1
BR$month = BR$phase
BR$latitude = BR$lat

rm(m)

g = ggplot(BR, aes(x = phase, y=  lat, col = year, alpha = (qval<=0.1)/2+0.3))
g + geom_point() + xlim(c(0,12)) + scale_x_continuous(breaks = 0:12) +
  ggtitle("Peak month of birth by latitude and years")


g = ggplot(BR, aes(x = phase, y=  lat, col = year, alpha = qval))
g + geom_point() + xlim(c(0,12)) + scale_x_continuous(breaks = 0:12) +
  scale_alpha(range = c(0.1,1))
  ggtitle("Peak month of birth by latitude and years")

  


g = ggplot(BR, aes(x = month, y=  latitude, col = year, alpha = significant_rhythm))
g + geom_point(size = 0.75) + #xlim(c(0,12)) +
  geom_hline(yintercept = 0)+
  scale_x_continuous(breaks = 0:12) +
  scale_alpha_discrete(range = c(0.2,1))+
  scale_color_gradient(low = "red4", high = "coral1")+
  ggtitle("Peak month of birth by latitude and years")


  


#mapw = map_data("world")

#g = ggplot()
#g + geom_polygon(data = mapw, aes(x=long, y = lat, group = group), fill=  NA, col = "gray") +
#  geom_point(data =BR, aes(x = lon + year-2000, y = lat, col = phase, alpha = (qval<=0.1)/2+0.3)) 
# non-transparent means significant. Phase is the month number
#rm(mapw)


```

We indeed observe this latitude-dependency for the peak time of birth. Interestingly, for some countries in the Nothern hemisphere, we also see a shift towards later later peak time in recent years.

Having a closer look to some countries with measurements for many years:


```{r intro_birth_seasonality shift in years}

c = which(BR$country %in% countries)

g = ggplot(BR[c,], aes(x = phase, y = year))
g + geom_point(aes(col = (qval <= 0.1))) + 
  facet_grid( country ~ .) + 
  theme_minimal() +
  theme(strip.text.y = element_text(angle = 0))+
  ggtitle("Shift in birth month since the 70's for many countries")
# note that for some countries, the trend for the phase does change over the years

subset_countries =  c("Sweden","Denmark","Finland","Canada","Germany", "France", "Switzerland", "United States","Israel","Japan")

g = ggplot(BR[BR$country %in% subset_countries, ], aes(x = phase, y = year, col = country))
g + geom_point(aes(alpha = (qval <= 0.1)/2+0.5)) +
    geom_path(data = BR[(BR$country %in% subset_countries) & (BR$qval <= 0.1),], aes(x = phase, y = year, col = country)) +
  xlim(c(0,12))+
  theme_minimal() +
  theme(strip.text.y = element_text(angle = 0))+
  ggtitle("Except for the US and Israel, most countries have seen their peak month of birth being delayed")

```


??? Maybe should first de-trend the data before computing the phase? But it does not seem to correlate with the overall trends...



We were then wondering if the amplitude of the oscillations were also dependent on latitude.


```{r intro_birth_seasonality relative amplitude and latitude}

g = ggplot(BR, aes(x =  rel.ampl , y =  lat, col = year, alpha = (qval<=0.1)/2+0.3))
g + geom_point() + ggtitle("Relative amplitude of birth seasonality by latitude")

```


It does not seem to be the case.

From informal discussions with Jamie Jones, we had suspicions that birth seasonality finds its origin from younger mother rather than from olter mother. (* provide more details here *)


We thus looked for data providing the average age of mothers at their first child for various countries.
We found two datasets:

* one dataset with recent data from countries around the world [chartmix.co](http://chartmix.co/view/MYB7ywk#data) & [CIA](https://www.cia.gov/library/publications/the-world-factbook/fields/2256.html)

* another dataset for  European Union (extended) countries with yearly data back to the 60's (Fertility Indicator table [http://ec.europa.eu/eurostat/data/database](http://ec.europa.eu/eurostat/data/database)


With the first dataset, we averaged the relative amplitudes

```{r intro_birth_seasonality loading mothers age data}

age = read.table(paste0(IO$public_birth_records,"average_women_age_at_first_child_birth.txt"), sep = ",", header = FALSE, stringsAsFactors = FALSE, quote = "|")


age = data.frame(country = age[seq(1,nrow(age)-1,by = 2),], age_at_first_child = age[seq(2,nrow(age),by = 2),] , stringsAsFactors = FALSE)

age$age_at_first_child = as.numeric(as.character(age$age_at_first_child))

age$country[age$country == "United States of America"] = "United States"

m = match(age$country, countriesLow$NAME)
age$lat = countriesLow$LAT[m]
age$lon = countriesLow$LON[m]
rm(m)




eufind_full = read.csv(paste0(IO$public_birth_records,"demo_find_1_Data.csv"))

j = which(eufind_full$INDIC_DE == "Mean age of women at birth of first child")
eufind = eufind_full[j,]


#j = which(eufind_full$INDIC_DE == "Mean age of women at childbirth")
#eufind = eufind_full[j,]


eufind$Value = as.character(eufind$Value )
eufind$Value = gsub(":", NA,eufind$Value )
eufind$Value = as.numeric(eufind$Value)


m = match(eufind$GEO, countriesLow$NAME)
eufind$lat = countriesLow$LAT[m]
eufind$lon = countriesLow$LON[m]
rm(m)

rm(eufind_full)

```



```{r intro_birth_seasonality displaying age at 1st birth}

mapw = map_data("world")
mapw$region = gsub("USA", "United States", mapw$region )

m = match(mapw$region, age$country)
mapw$age = age$age_at_first_child[m]
rm(m)

g = ggplot() 
g + geom_polygon(data = mapw, aes(x=long, y = lat, group = group, fill=  age)) + 
  scale_fill_gradient(low = "lightblue",high = "lightblue4", na.value="gray95")+
  coord_fixed(1.3) + ggtitle("Age of mothers at 1st child - ~2015 data")


g = ggplot(eufind, aes(x = TIME, y = Value, col = lat, group = GEO))
g + geom_line()+ 
  ggtitle("Age at first child in EU countries")+
  scale_color_gradient(low = "rosybrown3",high = "steelblue", na.value="gray95")



rm(mapw)

```


```{r intro_birth_seasonality first looking at the world data for recent years}

year.lim = 2012
cond = (BR$year >= year.lim) & (BR$qval <=0.1)

agg = aggregate(rel.ampl ~ country, BR[cond,], mean)
BS = agg

agg = aggregate(qval ~ country, BR[cond,], mean)
BS = merge(BS, agg, by = "country", all = TRUE)

agg = aggregate(phase ~ country, BR[cond,], mean)
BS = merge(BS, agg, by = "country", all = TRUE)

agg = aggregate(phase ~ country, BR[cond,], length)
colnames(agg) = c("country","n.years")
BS = merge(BS, agg, by = "country", all = TRUE)

m = match(BS$country, age$country)
BS$age_at_first_child = age$age_at_first_child[m]

m = match(BS$country, countriesLow$NAME)
BS$lat = countriesLow$LAT[m]
BS$lon = countriesLow$LON[m]

BSglm = glm(rel.ampl ~  age_at_first_child + lat + abs(lat) +phase  , data = BS, weights = n.years)
summary(BSglm)


```


```{r intro_birth_seasonality showing the prediction}


y = predict(BSglm, newdata = BS)

g = ggplot(BS, aes(x = age_at_first_child, y =rel.ampl, col = abs(lat), size = n.years))
g + geom_point() + theme_minimal()+  ylim(c(0,0.3)) + geom_point(aes(y = y), shape = "+", col = "red")+ ggtitle("Amplitude of birth seasonality VS age of mother at 1st child - worldwide, 2015 data")


```



Given the large variability in age at 1st child and evolution in Europe, we can also use the raw birth data to check if a similar relationship is found.

```{r intro_birth_seasonality BRglm }

m = match(BR$country, age$country)
BR$age_at_first_child = age$age_at_first_child[m]

m = merge(BR, eufind, by.x = c("country","year"), by.y = c("GEO","TIME"), all.x = TRUE)
BR = m
rm(m)

BR$lat = BR$lat.x
BR = BR[,-which(colnames(BR) %in% c("lat.x","lat.y"))]

BRglm = glm(rel.ampl ~ Value + lat + phase + year, data = BR[!is.na(BR$Value),])
summary(BRglm)

```



```{r intro_birth_seasonality showing the prediction for glm}

y = predict(BRglm, newdata = BR)

g = ggplot(BR, aes(x = Value, y =rel.ampl, col = year))
g + geom_point() + ylim(c(0,0.3)) + geom_point(aes(y = y), shape = "+", col = "red")+ ggtitle("Amplitude of birth seasonality VS age of mother at 1st child - EU 70s-2015 data")



```


```{r intro_birth_seasonality clean workspace}
rm(BRglm, BSglm, mapw, d, c, cc, cond, date)

```




### Birth seasonality - Summary

- Phase ( = peak month) of birth seasonality depends on latitude.
- Amplitude (~ fold change) of birth seasonality depends on age of mothers.


In EU and US (which is the main population of the two apps) in recent years, the phases are quite similar (despite the relatively large variation in latitude), we can thus use Sympto and Kindara's dataset to explore the origin of seasonality: i.e. is it a change in sexual behavior or a change in fertility? 


```{r intro_birth_seasonality showing the phase of the countries in which most Sympto (and Kindara) users are located}

countries.s = c("Germany", "Switzerland", "France","United States")


g = ggplot(BR[BR$country %in% countries.s,], aes(x = phase, y = year, col = country))
g + geom_point() + xlim(c(0,12)) + geom_hline(yintercept = 2010) +
  ggtitle("Countries for which we have users in Sympto's dataset have similar peak month in the last decade")

```


The peak birth month for these countries in recent years are July-August. The estimated time of conception is thus ~ November.


For Sympto, we have both location and user's birth year (age). For Kindara, we currently do not have access to this information.
Unfortunately, Sympto's dataset is a lot smaller than Kindara's dataset.

